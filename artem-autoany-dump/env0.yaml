version: 2
shell: bash

deploy:
  steps:
    terraformInit:
      before:
        - |
          set -euo pipefail
          echo "== GCP Authentication (WIF) =="
          if [[ -s "env0_credential_configuration.json" ]]; then
            export GOOGLE_APPLICATION_CREDENTIALS="env0_credential_configuration.json"
            gcloud auth login --cred-file="${GOOGLE_APPLICATION_CREDENTIALS}"
            echo "gcloud auth list:"
            gcloud auth list
          else
            echo "ERROR: env0_credential_configuration.json not found."
            echo "Attach a WIF credential so this file is present in the workspace,"
            echo "or switch to a Service Account key JSON via env0's Google Cloud integration."
            exit 1
          fi

          # --- Optional: set project (safe) ---
          if [[ -n "${GOOGLE_PROJECT:-}" ]]; then
            gcloud config set project "${GOOGLE_PROJECT}"
          fi

          # --- Optional: fetch kubeconfig (safe, read-only) ---
          # Requires: GKE auth plugin on runner and correct zone/region.
          if [[ -n "${GKE_CLUSTER:-}" ]]; then
            export USE_GKE_GCLOUD_AUTH_PLUGIN="${USE_GKE_GCLOUD_AUTH_PLUGIN:-True}"
            if [[ -n "${GKE_ZONE:-}" ]]; then
              gcloud container clusters get-credentials "${GKE_CLUSTER}" --zone "${GKE_ZONE}" --project "${GOOGLE_PROJECT:-}"
            elif [[ -n "${GKE_REGION:-}" ]]; then
              gcloud container clusters get-credentials "${GKE_CLUSTER}" --region "${GKE_REGION}" --project "${GOOGLE_PROJECT:-}"
            else
              echo "ERROR: Neither GKE_ZONE nor GKE_REGION set." >&2
              exit 1
            fi
            kubectl config current-context || true
          fi

destroy:
  steps:
    terraformInit:
      before:
        - |
          set -euo pipefail
          echo "== GCP Authentication (WIF) =="
          if [[ -s "env0_credential_configuration.json" ]]; then
            export GOOGLE_APPLICATION_CREDENTIALS="env0_credential_configuration.json"
            gcloud auth login --cred-file="${GOOGLE_APPLICATION_CREDENTIALS}"
            echo "gcloud auth list:"
            gcloud auth list
          else
            echo "ERROR: env0_credential_configuration.json not found."
            exit 1
          fi

          # Optional: set project and get kubeconfig (same as deploy)
          if [[ -n "${GOOGLE_PROJECT:-}" ]]; then
            gcloud config set project "${GOOGLE_PROJECT}"
          fi
          if [[ -n "${GKE_CLUSTER:-}" ]]; then
            export USE_GKE_GCLOUD_AUTH_PLUGIN="${USE_GKE_GCLOUD_AUTH_PLUGIN:-True}"
            if [[ -n "${GKE_ZONE:-}" ]]; then
              gcloud container clusters get-credentials "${GKE_CLUSTER}" --zone "${GKE_ZONE}" --project "${GOOGLE_PROJECT:-}"
            elif [[ -n "${GKE_REGION:-}" ]]; then
              gcloud container clusters get-credentials "${GKE_CLUSTER}" --region "${GKE_REGION}" --project "${GOOGLE_PROJECT:-}"
            else
              echo "ERROR: Neither GKE_ZONE nor GKE_REGION set." >&2
              exit 1
            fi
            kubectl config current-context || true
          fi

    terraformDestroy:
      before:
        - |
          set -euo pipefail
          echo "== Validate kubectl connectivity (server-side dry-run) =="
          if kubectl config current-context >/dev/null 2>&1; then
            kubectl delete all --all-namespaces \
              -l "env0-environment-id=${ENV0_ENVIRONMENT_ID}" \
              --ignore-not-found \
              --dry-run=server || true
          else
            echo "INFO: No kube context; skipping dry-run delete check."
          fi
