version: 2
shell: bash

# --- SAFETY SWITCHES (non-destructive defaults) ---
# Set VALIDATE_ONLY=true in Env0 variables if you want to *force* validation-only mode.
# By default, even without this flag, the flow is non-destructive.
environment_variables:
  - name: VALIDATE_ONLY
    value: "true"        # Extra safety: keeps destroy pre-checks in validation-only mode.

deploy:
  steps:
    setupVariables:
      after:
        # Hint the runner to ensure tools exist if your runner supports this pattern.
        # Safe: only influences runner setup; does not change cluster state.
        - echo ENV0_INSTALLED_TOOLS="gcloud,kubectl,gke-gcloud-auth-plugin" >> "$ENV0_ENV"
        - echo USE_GKE_GCLOUD_AUTH_PLUGIN="True" >> "$ENV0_ENV"

    terraformInit:
      before:
        - |
          set -euo pipefail
          echo "== Debug: env and versions =="
          echo "GOOGLE_PROJECT=${GOOGLE_PROJECT:-unset}"
          echo "GKE_CLUSTER=${GKE_CLUSTER:-unset}"
          echo "GKE_ZONE=${GKE_ZONE:-unset}  GKE_REGION=${GKE_REGION:-unset}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-unset}"
          echo "VALIDATE_ONLY=${VALIDATE_ONLY:-unset}"

          which gcloud || true
          gcloud --version || true
          which kubectl || true
          kubectl version --client --short || true

          # Required for newer GKE auth
          export USE_GKE_GCLOUD_AUTH_PLUGIN="${USE_GKE_GCLOUD_AUTH_PLUGIN:-True}"

          # Authenticate to GCP if SA is provided
          if [[ -n "${GOOGLE_APPLICATION_CREDENTIALS:-}" ]]; then
            gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
          fi

          # Set project if provided
          if [[ -n "${GOOGLE_PROJECT:-}" ]]; then
            gcloud config set project "$GOOGLE_PROJECT"
          fi

          # Establish kubeconfig *only* if target cluster is defined
          if [[ -n "${GKE_CLUSTER:-}" ]]; then
            if [[ -n "${GKE_ZONE:-}" ]]; then
              gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE" --project "${GOOGLE_PROJECT:-}"
            elif [[ -n "${GKE_REGION:-}" ]]; then
              gcloud container clusters get-credentials "$GKE_CLUSTER" --region "$GKE_REGION" --project "${GOOGLE_PROJECT:-}"
            else
              echo "ERROR: Neither GKE_ZONE nor GKE_REGION set." >&2
              exit 1
            fi
          else
            echo "INFO: GKE_CLUSTER not set; skipping kubeconfig setup."
          fi

          echo "== kubectl context =="
          echo "KUBECONFIG=${KUBECONFIG:-$HOME/.kube/config}"
          kubectl config current-context || true

          echo "== Connectivity smoke checks (read-only) =="
          # Read-only discovery to prove connectivity; no mutations.
          kubectl get ns --no-headers | head -n 5 || true
          kubectl auth can-i get pods --all-namespaces || true

destroy:
  steps:
    setupVariables:
      after:
        - echo ENV0_INSTALLED_TOOLS="gcloud,kubectl,gke-gcloud-auth-plugin" >> "$ENV0_ENV"
        - echo USE_GKE_GCLOUD_AUTH_PLUGIN="True" >> "$ENV0_ENV"

    terraformInit:
      before:
        - |
          set -euo pipefail
          echo "== Destroy: bootstrap GKE auth =="
          export USE_GKE_GCLOUD_AUTH_PLUGIN="${USE_GKE_GCLOUD_AUTH_PLUGIN:-True}"

          if [[ -n "${GOOGLE_APPLICATION_CREDENTIALS:-}" ]]; then
            gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
          fi
          if [[ -n "${GOOGLE_PROJECT:-}" ]]; then
            gcloud config set project "$GOOGLE_PROJECT"
          fi
          if [[ -n "${GKE_CLUSTER:-}" ]]; then
            if [[ -n "${GKE_ZONE:-}" ]]; then
              gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE" --project "${GOOGLE_PROJECT:-}"
            elif [[ -n "${GKE_REGION:-}" ]]; then
              gcloud container clusters get-credentials "$GKE_CLUSTER" --region "$GKE_REGION" --project "${GOOGLE_PROJECT:-}"
            else
              echo "ERROR: Neither GKE_ZONE nor GKE_REGION set." >&2
              exit 1
            fi
          else
            echo "INFO: GKE_CLUSTER not set; skipping kubeconfig setup."
          fi
          kubectl config current-context || true

    terraformDestroy:
      before:
        - |
          set -euo pipefail
          echo "== Validate kubectl connectivity with server-side dry-run =="

          # Absolute safety: This block never mutates cluster state.
          # 1) It only runs when kubeconfig exists.
          # 2) It uses --dry-run=server
          # 3) It's gated by VALIDATE_ONLY=true (default)
          if [[ "${VALIDATE_ONLY:-true}" == "true" ]]; then
            if kubectl config current-context >/dev/null 2>&1; then
              kubectl delete all --all-namespaces \
                -l "env0-environment-id=${ENV0_ENVIRONMENT_ID}" \
                --ignore-not-found \
                --dry-run=server || true
            else
              echo "INFO: No kube context; skipping dry-run delete check."
            fi
          else
            echo "SKIP: VALIDATE_ONLY=false, but this template never performs real deletes."
          fi
