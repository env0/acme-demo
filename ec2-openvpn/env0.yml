version: 2
deploy:
  steps:
    terraformInit:
      before:
        - echo "Installing OpenVPN"
        - sudo apk update
        - sudo apk add openvpn btrfs-progs e2fsprogs e2fsprogs-extra ip6tables iptables openssl shadow-uidmap xfsprogs xz openrc kmod linux-vanilla
        - sudo apk add --update coreutils
        - apk info -vv | grep -e '^linux-vanilla' | awk '{print $1}' | xargs -I{} sh -c 'apk fetch --quiet --stdout {} | tar -xz -C /lib/modules'
        - modprobe tun
        - find /lib/modules/ -iname 'tun.ko.gz'
        - insmod /lib/modules/3.6.9-1-ARCH/kernel/drivers/net/tun.ko.gz
        - echo $OPENVPN_CONFIG_FILE | base64 --decode > ~/config.ovpn
        - echo "Connecting"
        - openvpn --config ~/config.ovpn
        - sleep 10
        - nslookup rancher.dev 169.254.169.253