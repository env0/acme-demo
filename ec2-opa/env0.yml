version: 2

deploy:
  steps:
    terraformPlan:
      after:
        - name: OPA Scan
          use: https://github.com/env0/env0-opa-plugin
          inputs:
            path: ./rego
            flags: --fail --format=raw
            query: data.terraform.validation.violations[x]
    #     - name: Install OPA
    #       run: |
    #       - curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
    #       - chmod 755 ./opa
    #       - ./opa version
    #     - name: Run OPA Scan
    #       run: |
    #       echo $ENV0_TF_PLAN_JSON > tf-plan.json
    #       - ./opa eval --fail-defined "data.terraform.validation.violations[msg]" --input tf-plan.json --data ./rego/tf-lib.rego --data ./rego/validation.rego --format values 1>&2