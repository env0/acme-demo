version: 2
deploy:
  steps:
    terraformPlan:
      after:
        - name: "VMware Skip Test: Check Skip"
          run: |
            EXIT_CODE=2
            if [ '$(terraform show .tf-plan | grep -i "no changes.")' != '' ]; then EXIT_CODE=0; fi
            echo "exit code id $EXIT_CODE"
            echo TF_PLAN_EXIT_CODE=$EXIT_CODE >> $ENV0_ENV
    terraformApply:
      before:
        - name: "VMW Skip Test: Before Apply"
          run: |
            echo "TF_PLAN_EXIT_CODE value is $TF_PLAN_EXIT_CODE"
            if [ "$TF_PLAN_EXIT_CODE" == "0" ]; then echo "No changes, not running pre-apply flow" ; else echo "I'm running before the apply"; fi
      after:
        - name: "VMW Skip Test: After Apply"
          run: |
            echo "TF_PLAN_EXIT_CODE value is $TF_PLAN_EXIT_CODE"
            if [ "$TF_PLAN_EXIT_CODE" == "0" ]; then echo "No changes, not running post-apply flow" ; else echo "I'm running after the apply"; fi
