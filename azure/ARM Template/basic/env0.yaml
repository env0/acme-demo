### https://learn.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli#4-sign-in-using-a-service-principal

version: 2

deploy:
  steps:
    setupVariables: &azlogin
      after:
        - name: AZ LOGIN
          run: | 
            az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
    terraformPlan:
      before:
        - name: ARM Deployment What-If
          run: |
            az deployment group what-if --name $ENV0_ENVIRONMENT_ID --resource-group $AZURE_DEFAULTS_GROUP --template-file azuredeploy.json --parameters $ARM_PARAMETERS --no-pretty-print > azuredeploy.plan.json
            jq -C . azuredeploy.plan.json
    terraformApply:
      before:
        - name: ARM Deployment Create
          run: |
            export
            az deployment group create --name $ENV0_ENVIRONMENT_ID --resource-group $AZURE_DEFAULTS_GROUP --template-file azuredeploy.json --parameters $ARM_PARAMETERS
      after:
        - name: ARM Deployment Wait
          run: |
            az deployment group wait --name $ENV0_ENVIRONMENT_ID --resource-group $AZURE_DEFAULTS_GROUP --created
destroy:
  steps:
    setupVariables: *azlogin
    terraformDestroy:
      after:
        - name: ARM Deplyoment Destroy
          run: |
            az deployment group delete --name $ENV0_ENVIRONMENT_ID --resource-group $AZ_RESOURCE_GROUP